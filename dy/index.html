<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <!-- iOS 相关meta标签 -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="随机舞蹈">
        <!-- 添加到主屏幕的图标 -->
        <link rel="apple-touch-icon" href="icon-180.png">
        <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
        <link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
        <!-- 启动画面 -->
        <link rel="apple-touch-startup-image" href="launch.png">
        <title>随机舞蹈视频</title>
        <style>
</style>
    </head>
    
    <body>
        <div class="container">
            <div class="video-container">
                <video id="danceVideo" controls>您的浏览器不支持视频播放。</video>
            </div>
            <div class="controls">
                <button class="next-button" onclick="nextVideo()">下一个</button>
                <button class="refresh-button" onclick="refreshVideo()">刷新</button>
                <button class="play-toggle-button" onclick="togglePlay()">暂停/播放</button>
                <button class="like-button" onclick="createHearts()">点赞</button>
                <button class="pip-button" onclick="togglePip()">画中画</button>
            </div>
            <div class="alert" id="alertBox">复制成功，请打开浏览器进行下载保存！</div>
            <div class="copyright"><a href="https://www.dadawz.cn/" id="copyrightLink">© 2024 大大-随机舞蹈. 保留所有权利.</a>
            </div>
            <!-- 大大博客 https://www.dadawz.cn/-->
        </div>
        <script>
            /**
             * @type {HTMLVideoElement}
             */
            const video = document.getElementById('danceVideo');

            /**
             * 视频源数组 - 可以替换为您自己的API或视频源
             * @type {string[]}
             */
            const videoSources = [
                'https://api.yviii.com/video/suiji.php',
                'https://api.yviii.com/video/i.php',
                'http://api.mhycloud.fun:81/api/dy',
            ];

            /**
             * 获取随机视频源
             * @returns {string} 随机视频URL
             */
            function getRandomVideo() {
                const randomIndex = Math.floor(Math.random() * videoSources.length);
                return videoSources[randomIndex];
            }

            /**
             * 添加加载状态处理
             */
            function setLoading(isLoading) {
                const video = document.getElementById('danceVideo');
                if (isLoading) {
                    video.classList.add('loading');
                } else {
                    video.classList.remove('loading');
                }
            }

            /**
             * 增强版的下一个视频函数
             */
            async function nextVideo() {
                setLoading(true);
                const newSrc = getRandomVideo();
                // 确保不会连续播放同一个视频
                if (newSrc === video.src) {
                    return nextVideo();
                }
                video.src = newSrc;
                try {
                    await video.play();
                } catch (error) {
                    console.error('视频播放失败:', error);
                }
                video.oncanplay = () => {
                    setLoading(false);
                };
            }

            /**
             * 刷新当前视频
             */
            function refreshVideo() {
                video.currentTime = 0;
                video.play();
            }

            /**
             * 切换视频播放/暂停状态
             */
            function togglePlay() {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            }

            /**
             * 创建爱心动画效果
             */
            function createHearts() {
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.innerHTML = ['❤️', '⭐', '✨', '💖', '💕'][Math.floor(Math.random() * 5)];
                        heart.className = 'floating-heart';
                        heart.style.left = Math.random() * window.innerWidth + 'px';
                        heart.style.fontSize = (20 + Math.random() * 20) + 'px';
                        document.body.appendChild(heart);

                        setTimeout(() => {
                            heart.remove();
                        }, 3000);
                    }, i * 100);
                }
            }

            /**
             * 切换画中画模式
             */
            function togglePip() {
                if (document.pictureInPictureElement) {
                    document.exitPictureInPicture().catch(error => {
                        console.error('退出画中画失败:', error);
                    });
                } else {
                    video.requestPictureInPicture().catch(error => {
                        console.error('进入画中画失败:', error);
                    });
                }
            }

            // 禁用双指缩放
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });

            // 处理iOS的各种手势
            let touchStartY = 0;
            document.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
            }, {
                passive: false
            });

            document.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const delta = touchStartY - touchY;

                // 如果不是在视频上滑动，则阻止默认行为
                if (!e.target.matches('video')) {
                    e.preventDefault();
                }
            }, {
                passive: false
            });

            // 添加iOS的错误处理
            video.addEventListener('error', function(e) {
                console.error('视频加载错误:', e.target.error);
                nextVideo();
            });

            // 处理iOS后台播放
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    video.pause();
                }
            });

            // 初始化
            window.onload = function() {
                nextVideo();
                video.addEventListener('ended', nextVideo); // 播放完自动播放下一个
            };
        </script>
    </body>

</html>
